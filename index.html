<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="mvp.css" />
    <script src="lame.min.js"></script>
  </head>
  <body>
    <section>
      <aside>
        <label>convert wave to mp3</label>
        <input type="file" style="width: 90%" />
        <div style="display: flex">
          <select id="bitRate">
            <option>8</option>
            <option selected>192</option>
          </select>
          <span > kbit/s </span>
        </div>
        <button>convert</button>
        <audio controls src=""></audio>
      </aside>
    </section>
    <script>
      var appendToBuffer = function (mp3Buf) {
        dataBuffer.push(new Int8Array(mp3Buf));
      };
      var mp3Encoder,
        maxSamples = 1152,
        wav,
        samplesLeft,
        config = {},
        dataBuffer,
        samplesRight;

      document.querySelector("button").onclick = () => {
        const file = document.querySelector("input").files[0]
        console.log(file.name)
        if (!file) {
          alert("선택된 파일이 없음")
          return
        }
        config.bitRate = parseInt(document.querySelector("#bitRate").value, 10);
        encode(file);
      };

      function encode(e) {
        dataBuffer = [];
        const fileReader = new FileReader();
        fileReader.readAsArrayBuffer(e);
        fileReader.onload = function (r) {
          const arraybuffer = r.target.result;
          wav = lamejs.WavHeader.readHeader(new DataView(arraybuffer));
          var dataView = new Int16Array(
            arraybuffer,
            wav.dataOffset,
            wav.dataLen / 2
          );
          samplesLeft =
            wav.channels === 1
              ? dataView
              : new Int16Array(wav.dataLen / (2 * wav.channels));
          samplesRight =
            wav.channels === 2
              ? new Int16Array(wav.dataLen / (2 * wav.channels))
              : undefined;
          if (wav.channels > 1) {
            for (var i = 0; i < samplesLeft.length; i++) {
              samplesLeft[i] = dataView[i * 2];
              samplesRight[i] = dataView[i * 2 + 1];
            }
          }
          mp3Encoder = new lamejs.Mp3Encoder(
            wav.channels,
            wav.sampleRate,
            config?.bitRate || 96
          );

          var remaining = samplesLeft.length;
          for (var i = 0; remaining >= maxSamples; i += maxSamples) {
            var left = samplesLeft.subarray(i, i + maxSamples);
            var right;
            if (samplesRight) {
              right = samplesRight.subarray(i, i + maxSamples);
            }
            var mp3buf = mp3Encoder.encodeBuffer(left, right);
            appendToBuffer(mp3buf);
            remaining -= maxSamples;
          }
          var mp3buf = mp3Encoder.flush();
          appendToBuffer(mp3buf);
          var mp3Blob = new Blob(dataBuffer, { type: "audio/mp3" });
          var blobUrl = window.URL.createObjectURL(mp3Blob);
          document.querySelector("audio").src = blobUrl;
        };
      }
    </script>
  </body>
</html>
